# SPDX-License-Identifier: Apache-2.0
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

env:
  BOARD: native_sim

tasks:
  build:
    desc: Build the Fusain library for native_sim
    cmd: west build -b native_sim

  rebuild:
    desc: Rebuild the Fusain library from scratch
    cmd: west build -b native_sim -p always

  clean:
    desc: Clean build artifacts
    cmd: rm -rf build

  auto-build:
    desc: Build the Fusain library automatically when files are saved
    watch: true
    sources:
      - src/**
      - include/**
      - CMakeLists.txt
      - Kconfig
    cmd: west build -b native_sim

  menuconfig:
    desc: Start menuconfig to configure the Fusain library
    cmds:
      - west build -b native_sim -t menuconfig
      - task: build-firmware

  config-diff:
    desc: Display Zephyr's Kconfig diff
    ignore_error: true
    cmd: diff --color build/zephyr/.config.old build/zephyr/.config

  test:
    desc: Run Fusain test suite with optional fuzz round count (e.g., 'task test -- 420')
    vars:
      ROUNDS: '{{default "100" .CLI_ARGS}}'
    cmds:
      - |
        if [ -n "{{.CLI_ARGS}}" ]; then
          rm -rf twister-out twister-out.*
          west twister -T tests -x CONFIG_FUSAIN_TEST_FUZZ_ROUNDS={{.ROUNDS}} --enable-slow -v
        else
          west twister -T tests --enable-slow -v
        fi
        TEST_EXIT=$?
        if [ $TEST_EXIT -eq 0 ]; then
          echo "Tests passed - cleaning up artifacts"
          rm -rf twister-out twister-out.*
        else
          echo "Tests failed - preserving artifacts for debugging"
          exit $TEST_EXIT
        fi

  test-functional:
    desc: Run only functional tests (no fuzzing, no round count)
    cmds:
      - |
        west twister -T tests -s libraries.fusain.functional -v
        TEST_EXIT=$?
        if [ $TEST_EXIT -eq 0 ]; then
          echo "Tests passed - cleaning up artifacts"
          rm -rf twister-out twister-out.*
        else
          echo "Tests failed - preserving artifacts for debugging"
          exit $TEST_EXIT
        fi

  test-fuzz:
    desc: Run only fuzz tests with optional round count (e.g., 'task test-fuzz -- 5000')
    vars:
      ROUNDS: '{{default "1000" .CLI_ARGS}}'
    cmds:
      - |
        if [ -n "{{.CLI_ARGS}}" ]; then
          rm -rf twister-out twister-out.*
          west twister -T tests -s libraries.fusain.fuzz -x CONFIG_FUSAIN_TEST_FUZZ_ROUNDS={{.ROUNDS}} --enable-slow -v
        else
          west twister -T tests -s libraries.fusain.fuzz --enable-slow -v
        fi
        TEST_EXIT=$?
        if [ $TEST_EXIT -eq 0 ]; then
          echo "Tests passed - cleaning up artifacts"
          rm -rf twister-out twister-out.*
        else
          echo "Tests failed - preserving artifacts for debugging"
          exit $TEST_EXIT
        fi

  format:
    desc: Format C source files using clang-format
    cmds:
      - clang-format -i src/*.c include/fusain/*.h tests/src/*.c
      - clang-format -i tests/standalone/*.c tests/standalone/zephyr/*.h

  format-check:
    desc: Check if C source files are formatted correctly
    cmds:
      - |
        RESULT=$(clang-format --dry-run --Werror src/*.c include/fusain/*.h tests/src/*.c tests/standalone/*.c tests/standalone/zephyr/*.h 2>&1)
        if [ $? -ne 0 ]; then
          echo "Formatting issues found:"
          echo "$RESULT"
          echo ""
          echo "Run 'task format' to fix formatting issues."
          exit 1
        else
          echo "All files are correctly formatted."
        fi

  ci:
    desc: Run CI checks - format check and test suite with 1,000,000 fuzz rounds
    cmds:
      - echo "Running CI checks..."
      - echo ""
      - task: format-check
      - echo ""
      - echo "Running test suite with 1,000,000 fuzz rounds..."
      - echo "This will take several minutes. Please be patient."
      - task: test
        vars:
          CLI_ARGS: "5000000"

  install-git-hooks:
    desc: Install pre-commit hook that runs CI tests
    cmds:
      - |
        if [ ! -d ".git" ]; then
          echo "Error: Not in a git repository. Run this from the fusain directory."
          exit 1
        fi

        if [ ! -f "git-hooks/pre-commit" ]; then
          echo "Error: git-hooks/pre-commit not found."
          exit 1
        fi

        mkdir -p .git/hooks
        cp git-hooks/pre-commit .git/hooks/pre-commit
        chmod +x .git/hooks/pre-commit

        echo "âœ“ Pre-commit hook installed at .git/hooks/pre-commit"
        echo ""
        echo "The hook will run on every commit and check:"
        echo "  1. Code formatting (fast)"
        echo "  2. CI test suite with 1,000,000 fuzz rounds (slow)"
        echo ""
        echo "To skip the hook for a commit, use: git commit --no-verify"
        echo "To uninstall: rm .git/hooks/pre-commit"

  # ============================================================
  # Standalone Mode Tasks (no Zephyr required)
  # ============================================================

  standalone-build:
    desc: Build the standalone fusain library (no Zephyr)
    cmds:
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=OFF
      - cmake --build build-standalone

  standalone-build-tests:
    desc: Build the standalone library with tests
    cmds:
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON
      - cmake --build build-standalone

  standalone-test:
    desc: Run standalone tests (no Zephyr)
    deps: [standalone-build-tests]
    cmd: ctest --test-dir build-standalone --output-on-failure

  standalone-test-verbose:
    desc: Run standalone tests with verbose output
    deps: [standalone-build-tests]
    cmd: build-standalone/tests/standalone/fusain_tests

  standalone-clean:
    desc: Clean standalone build artifacts
    cmds:
      - rm -rf build-standalone
      - rm -rf coverage-standalone

  standalone-coverage:
    desc: Run standalone tests with coverage report (using gcovr)
    cmds:
      - mkdir -p coverage-standalone
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
      - cmake --build build-standalone
      - build-standalone/tests/standalone/fusain_tests
      - |
        echo ""
        echo "Coverage report:"
        gcovr --root . --filter src/ build-standalone 2>/dev/null || \
        (echo "gcovr not found. Install with: pip install gcovr" && \
         echo "Falling back to basic gcov..." && \
         cd build-standalone/CMakeFiles/fusain.dir/src && gcov fusain.c.gcno && cat fusain.c.gcov | head -100)

  standalone-coverage-check:
    desc: Verify 100% test coverage (fails if coverage < 100%)
    cmds:
      - mkdir -p coverage-standalone
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
      - cmake --build build-standalone
      - build-standalone/tests/standalone/fusain_tests
      - |
        echo ""
        echo "Checking coverage (must be 100%)..."
        gcovr --root . --filter src/ --fail-under-line 100 build-standalone
        if [ $? -eq 0 ]; then
          echo "Coverage check passed: 100% line coverage"
        else
          echo ""
          echo "Coverage check FAILED: coverage is below 100%"
          exit 1
        fi

  standalone-ci:
    desc: Run standalone CI checks - format, tests, and 100% coverage
    cmds:
      - echo "Running fusain standalone CI checks..."
      - echo ""
      - task: format-check
      - echo ""
      - task: standalone-coverage-check
      - echo ""
      - echo "Standalone CI checks passed!"
