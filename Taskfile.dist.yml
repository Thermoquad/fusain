# SPDX-License-Identifier: Apache-2.0
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CDDL_PATH: ../../../origin/documentation/source/specifications/fusain/fusain.cddl
  CDDL_TYPES: >-
    motor-config-payload pump-config-payload temp-config-payload glow-config-payload
    data-subscription-payload telemetry-config-payload timeout-config-payload
    state-command-payload motor-command-payload pump-command-payload glow-command-payload
    temp-command-payload send-telemetry-payload
    state-data-payload motor-data-payload pump-data-payload glow-data-payload
    temp-data-payload device-announce-payload ping-response-payload
    error-invalid-cmd-payload error-state-reject-payload

env:
  BOARD: native_sim

tasks:
  build:
    desc: Build the Fusain library for native_sim
    cmd: west build -b native_sim

  rebuild:
    desc: Rebuild the Fusain library from scratch
    cmd: west build -b native_sim -p always

  clean:
    desc: Clean build artifacts
    cmd: rm -rf build tests/build build-standalone coverage-standalone twister-out twister-out.*

  auto-build:
    desc: Build the Fusain library automatically when files are saved
    watch: true
    sources:
      - src/**
      - include/**
      - CMakeLists.txt
      - Kconfig
    cmd: west build -b native_sim

  menuconfig:
    desc: Start menuconfig to configure the Fusain library
    cmds:
      - west build -b native_sim -t menuconfig
      - task: build-firmware

  config-diff:
    desc: Display Zephyr's Kconfig diff
    ignore_error: true
    cmd: diff --color build/zephyr/.config.old build/zephyr/.config

  test:
    desc: Run Fusain test suite with optional fuzz round count (e.g., 'task test -- 420')
    vars:
      ROUNDS: '{{default "100" .CLI_ARGS}}'
      SEED:
        sh: "od -An -tx4 -N4 /dev/urandom | tr -d ' '"
    cmds:
      - 'echo "Using fuzz seed: 0x{{.SEED}}"'
      - rm -rf twister-out twister-out.*
      - 'west twister -T tests -x CONFIG_FUSAIN_TEST_FUZZ_ROUNDS={{.ROUNDS}} -x CONFIG_FUSAIN_TEST_FUZZ_SEED=0x{{.SEED}} --enable-slow -v'
      - rm -rf twister-out twister-out.*

  test-functional:
    desc: Run only functional tests (no fuzzing, no round count)
    vars:
      SEED:
        sh: "od -An -tx4 -N4 /dev/urandom | tr -d ' '"
    cmds:
      - 'echo "Using fuzz seed: 0x{{.SEED}}"'
      - rm -rf twister-out twister-out.*
      - 'west twister -T tests -s libraries.fusain.functional -x CONFIG_FUSAIN_TEST_FUZZ_SEED=0x{{.SEED}} -v'
      - rm -rf twister-out twister-out.*

  test-fuzz:
    desc: Run only fuzz tests with optional round count (e.g., 'task test-fuzz -- 5000')
    vars:
      ROUNDS: '{{default "1000" .CLI_ARGS}}'
      SEED:
        sh: "od -An -tx4 -N4 /dev/urandom | tr -d ' '"
    cmds:
      - 'echo "Using fuzz seed: 0x{{.SEED}}"'
      - rm -rf twister-out twister-out.*
      - 'west twister -T tests -s libraries.fusain.fuzz -x CONFIG_FUSAIN_TEST_FUZZ_ROUNDS={{.ROUNDS}} -x CONFIG_FUSAIN_TEST_FUZZ_SEED=0x{{.SEED}} --enable-slow -v'
      - rm -rf twister-out twister-out.*

  coverage:
    desc: Run Zephyr tests with coverage report
    cmds:
      - rm -rf tests/build
      - west build -b native_sim -d tests/build tests -- -DEXTRA_CONF_FILE=coverage.conf
      - tests/build/zephyr/zephyr.exe
      - |
        echo ""
        echo "Coverage report (fusain sources only):"
        gcovr \
          --filter 'src/fusain\.c$' \
          --filter 'src/fusain_net_buf\.c$' \
          tests/build

  coverage-check:
    desc: Verify Zephyr test coverage meets thresholds (100% fusain.c, 90% fusain_net_buf.c)
    cmds:
      - rm -rf tests/build
      - west build -b native_sim -d tests/build tests -- -DEXTRA_CONF_FILE=coverage.conf
      - tests/build/zephyr/zephyr.exe
      - 'echo ""'
      - 'echo "Checking coverage on fusain.c (must be 100%)..."'
      - gcovr --root . --filter 'src/fusain\.c$' --fail-under-line 100 tests/build
      - 'echo "Coverage check passed: 100% line coverage on fusain.c"'
      - 'echo ""'
      - 'echo "Checking coverage on fusain_net_buf.c (must be >= 90%)..."'
      - gcovr --root . --filter 'src/fusain_net_buf\.c$' --fail-under-line 90 tests/build
      - 'echo "Coverage check passed: >= 90% line coverage on fusain_net_buf.c"'

  format:
    desc: Format C source files using clang-format
    cmds:
      - clang-format -i src/*.c include/fusain/*.h tests/src/*.c
      - clang-format -i tests/standalone/*.c tests/standalone/zephyr/*.h tests/standalone/zephyr/random/*.h

  format-check:
    desc: Check if C source files are formatted correctly
    cmds:
      - clang-format --dry-run --Werror src/*.c include/fusain/*.h tests/src/*.c tests/standalone/*.c tests/standalone/zephyr/*.h tests/standalone/zephyr/random/*.h
      - echo "All files are correctly formatted."

  ci:
    desc: Run all CI checks - format, coverage, and fuzz tests
    cmds:
      - echo "Running CI checks..."
      - echo ""
      - echo "1. Format check..."
      - task: format-check
      - echo ""
      - echo "2. Standalone tests with 100% coverage verification..."
      - task: standalone-coverage-check
      - echo ""
      - echo "3. Standalone fuzz tests with 1,000,000 rounds..."
      - task: standalone-fuzz
        vars:
          CLI_ARGS: "1000000"
      - echo ""
      - echo "4. Zephyr tests with coverage verification..."
      - task: coverage-check
      - echo ""
      - echo "5. Zephyr fuzz tests with 5,000,000 rounds..."
      - task: test
        vars:
          CLI_ARGS: "5000000"
      - echo ""
      - echo "All CI checks passed!"

  install-git-hooks:
    desc: Install pre-commit hook that runs CI tests
    preconditions:
      - sh: test -d .git
        msg: "Error: Not in a git repository. Run this from the fusain directory."
      - sh: test -f git-hooks/pre-commit
        msg: "Error: git-hooks/pre-commit not found."
    cmds:
      - mkdir -p .git/hooks
      - cp git-hooks/pre-commit .git/hooks/pre-commit
      - chmod +x .git/hooks/pre-commit
      - |
        echo "Pre-commit hook installed at .git/hooks/pre-commit"
        echo ""
        echo "The hook will run on every commit and check:"
        echo "  1. Code formatting (fast)"
        echo "  2. CI test suite with 1,000,000 fuzz rounds (slow)"
        echo ""
        echo "To skip the hook for a commit, use: git commit --no-verify"
        echo "To uninstall: rm .git/hooks/pre-commit"

  # ============================================================
  # CBOR Code Generation
  # ============================================================

  zcbor-generate:
    desc: Regenerate CBOR code from fusain.cddl schema
    sources:
      - "{{.CDDL_PATH}}"
    generates:
      - src/generated/cbor_decode.c
      - src/generated/cbor_encode.c
      - include/fusain/generated/cbor_types.h
      - include/fusain/generated/cbor_decode.h
      - include/fusain/generated/cbor_encode.h
    cmds:
      - mkdir -p src/generated include/fusain/generated
      # Generate CBOR code with zcbor
      - zcbor code
          --cddl {{.CDDL_PATH}}
          --output-c src/generated/fusain_cbor.c
          --output-h src/generated/fusain_cbor.h
          -t {{.CDDL_TYPES}}
          --decode --encode
      # Rename source files
      - mv src/generated/fusain_cbor_decode.c src/generated/cbor_decode.c
      - mv src/generated/fusain_cbor_encode.c src/generated/cbor_encode.c
      # Move headers to include directory
      - mv src/generated/fusain_cbor_types.h include/fusain/generated/cbor_types.h
      - mv src/generated/fusain_cbor_decode.h include/fusain/generated/cbor_decode.h
      - mv src/generated/fusain_cbor_encode.h include/fusain/generated/cbor_encode.h
      # Fix internal includes in headers
      - sed -i 's/fusain_cbor_types\.h/cbor_types.h/g' include/fusain/generated/cbor_decode.h include/fusain/generated/cbor_encode.h
      # Fix includes in source files to use proper paths
      - sed -i 's|#include "fusain_cbor_decode.h"|#include <fusain/generated/cbor_decode.h>|g' src/generated/cbor_decode.c
      - sed -i 's|#include "fusain_cbor_encode.h"|#include <fusain/generated/cbor_encode.h>|g' src/generated/cbor_encode.c
      # Show results
      - echo "Generated files:"
      - wc -l src/generated/*.c include/fusain/generated/*.h

  # ============================================================
  # Standalone Mode Tasks (no Zephyr required)
  # ============================================================

  standalone-build:
    desc: Build the standalone fusain library (no Zephyr)
    cmds:
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=OFF
      - cmake --build build-standalone

  standalone-build-tests:
    desc: Build the standalone library with tests
    cmds:
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON
      - cmake --build build-standalone

  standalone-test:
    desc: Run standalone tests (no Zephyr)
    deps: [standalone-build-tests]
    cmd: ctest --test-dir build-standalone --output-on-failure

  standalone-test-verbose:
    desc: Run standalone tests with verbose output
    deps: [standalone-build-tests]
    cmd: build-standalone/tests/standalone/fusain_tests

  standalone-clean:
    desc: Clean standalone build artifacts
    cmds:
      - rm -rf build-standalone
      - rm -rf coverage-standalone

  standalone-coverage:
    desc: Run standalone tests with coverage report (using gcovr)
    cmds:
      - mkdir -p coverage-standalone
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
      - cmake --build build-standalone
      - build-standalone/tests/standalone/fusain_tests
      - |
        echo ""
        echo "Coverage report (excluding generated code):"
        gcovr --root . --filter 'src/fusain\.c$' build-standalone 2>/dev/null || \
        (echo "gcovr not found. Install with: pip install gcovr" && \
         echo "Falling back to basic gcov..." && \
         cd build-standalone/CMakeFiles/fusain.dir/src && gcov fusain.c.gcno && cat fusain.c.gcov | head -100)

  standalone-coverage-check:
    desc: Verify 100% test coverage on fusain.c (excludes generated code)
    cmds:
      - mkdir -p coverage-standalone
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
      - cmake --build build-standalone
      - build-standalone/tests/standalone/fusain_tests
      - echo ""
      - 'echo "Checking coverage on src/fusain.c (must be 100%)..."'
      - gcovr --root . --filter 'src/fusain\.c$' --fail-under-line 100 build-standalone
      - 'echo "Coverage check passed: 100% line coverage on fusain.c"'

  standalone-fuzz:
    desc: Run standalone fuzz tests with optional round count (e.g., 'task standalone-fuzz -- 5000')
    vars:
      ROUNDS: '{{default "1000" .CLI_ARGS}}'
      SEED:
        sh: "od -An -tx4 -N4 /dev/urandom | tr -d ' '"
    cmds:
      - 'echo "Using fuzz seed: 0x{{.SEED}}"'
      - rm -rf build-standalone
      - cmake -B build-standalone -DFUSAIN_BUILD_TESTS=ON -DFUSAIN_FUZZ_ROUNDS={{.ROUNDS}} -DFUSAIN_FUZZ_SEED=0x{{.SEED}}
      - cmake --build build-standalone
      - build-standalone/tests/standalone/fusain_tests

  standalone-ci:
    desc: Run standalone CI checks (no Zephyr required) - format, coverage, fuzz
    cmds:
      - echo "Running standalone CI checks..."
      - echo ""
      - echo "1. Format check..."
      - task: format-check
      - echo ""
      - echo "2. Standalone tests with 100% coverage verification..."
      - task: standalone-coverage-check
      - echo ""
      - echo "3. Standalone fuzz tests with 1,000,000 rounds..."
      - task: standalone-fuzz
        vars:
          CLI_ARGS: "1000000"
      - echo ""
      - echo "Standalone CI checks passed!"

  ci-in-docker:
    desc: Run full CI in Docker container
    vars:
      ZEPHYR_SDK_VERSION:
        sh: cat .zephyr-sdk-version
      UID:
        sh: id -u
      GID:
        sh: id -g
    env:
      CI_SCRIPT: |
        set -e
        python3 -m venv /tmp/venv
        . /tmp/venv/bin/activate
        pip install --quiet west gcovr
        west init -l fusain
        west update --narrow -o=--depth=1
        export ZEPHYR_BASE=/workdir/zephyr
        west packages pip --install
        cd fusain
        rm -rf build-standalone tests/build
        task ci
    cmds:
      - docker build --build-arg ZEPHYR_SDK_VERSION={{.ZEPHYR_SDK_VERSION}} -t fusain-ci {{.ROOT_DIR}}
      - docker run --rm --user {{.UID}}:{{.GID}} -e HOME=/tmp -v {{.ROOT_DIR}}:/workdir/fusain -w /workdir fusain-ci bash -c "${CI_SCRIPT}"
