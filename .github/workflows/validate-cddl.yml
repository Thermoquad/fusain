# SPDX-License-Identifier: Apache-2.0
name: Validate CDDL Schema

# Run every Friday at 9:00 AM UTC (gives weekend for fixes)
on:
  schedule:
    - cron: '0 9 * * 5'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  issues: write
  models: read # Required for GitHub Models API

jobs:
  validate:
    name: Validate C Implementation Against Reference CDDL
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fusain library
        uses: actions/checkout@v4
        with:
          path: fusain

      - name: Checkout origin repository
        uses: actions/checkout@v4
        with:
          repository: Thermoquad/origin
          path: origin
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Task
        uses: arduino/setup-task@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install zcbor
        run: pip install zcbor

      - name: Save current generated code
        run: |
          cd fusain
          mkdir -p /tmp/original
          cp -r src/generated /tmp/original/
          cp -r include/fusain/generated /tmp/original/include-generated

      - name: Regenerate CBOR code from reference CDDL
        run: |
          cd fusain
          # Force regeneration from the reference CDDL
          task zcbor-generate --force

      - name: Check for differences
        id: diff
        run: |
          cd fusain

          # Compare generated files
          if ! diff -r /tmp/original/generated src/generated > /tmp/diff-src.txt 2>&1; then
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "## Source File Differences" >> /tmp/diff-summary.md
            echo '```diff' >> /tmp/diff-summary.md
            cat /tmp/diff-src.txt >> /tmp/diff-summary.md
            echo '```' >> /tmp/diff-summary.md
            echo "" >> /tmp/diff-summary.md
          fi

          if ! diff -r /tmp/original/include-generated include/fusain/generated > /tmp/diff-include.txt 2>&1; then
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "## Header File Differences" >> /tmp/diff-summary.md
            echo '```diff' >> /tmp/diff-summary.md
            cat /tmp/diff-include.txt >> /tmp/diff-summary.md
            echo '```' >> /tmp/diff-summary.md
          fi

          # If no differences found
          if [ ! -f /tmp/diff-summary.md ]; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "✅ C Fusain implementation is in sync with reference CDDL" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate AI summary of discrepancies
        if: steps.diff.outputs.has_diff == 'true'
        id: ai_summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the diff summary
            let diffSummary = '';
            try {
              diffSummary = fs.readFileSync('/tmp/diff-summary.md', 'utf8');
            } catch (err) {
              diffSummary = 'Error reading diff summary';
            }

            // Prepare prompt for GitHub Models
            const prompt = `Analyze the following code differences between the C implementation of the Fusain protocol and the reference CDDL schema. The differences shown are from regenerating CBOR code from the canonical CDDL schema.

            Provide a concise summary that includes:
            1. What changed in the schema vs the current implementation
            2. Impact on the C API or binary compatibility
            3. Whether this requires updating src/fusain.c
            4. Severity (breaking change, enhancement, or fix)

            Differences:
            ${diffSummary}

            Provide a clear, structured summary suitable for a GitHub issue.`;

            try {
              // Call GitHub Models API to summarize the differences
              const response = await fetch('https://models.github.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${{ secrets.GITHUB_TOKEN }}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  messages: [
                    {
                      role: 'system',
                      content: 'You are an expert at analyzing protocol implementations and schema changes. Provide clear, actionable summaries.'
                    },
                    {
                      role: 'user',
                      content: prompt
                    }
                  ],
                  temperature: 0.3,
                  max_tokens: 1000
                })
              });

              if (!response.ok) {
                const errorText = await response.text();
                console.error('GitHub Models API error:', response.status, errorText);
                core.setOutput('summary', '⚠️ Could not generate AI summary (API error). Please review the diff manually.');
                core.setOutput('use_fallback', 'true');
                return;
              }

              const data = await response.json();
              const aiSummary = data.choices[0].message.content;

              core.setOutput('summary', aiSummary);
              core.setOutput('use_fallback', 'false');

            } catch (error) {
              console.error('Error calling GitHub Models:', error);
              core.setOutput('summary', '⚠️ Could not generate AI summary (network error). Please review the diff manually.');
              core.setOutput('use_fallback', 'true');
            }

      - name: Create issue for discrepancies
        if: steps.diff.outputs.has_diff == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read diff summary
            const diffSummary = fs.readFileSync('/tmp/diff-summary.md', 'utf8');

            // Get AI summary
            const aiSummary = `${{ steps.ai_summary.outputs.summary }}`;
            const useFallback = `${{ steps.ai_summary.outputs.use_fallback }}` === 'true';

            // Build issue body
            let issueBody = `# C Fusain Implementation Diverged from Reference CDDL\n\n`;
            issueBody += `The weekly validation check found that the C Fusain implementation has diverged from the reference CDDL schema.\n\n`;

            if (!useFallback) {
              issueBody += `## AI Analysis\n\n${aiSummary}\n\n`;
            }

            issueBody += `## Detected on\n\n`;
            issueBody += `- **Date**: ${new Date().toISOString().split('T')[0]}\n`;
            issueBody += `- **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

            issueBody += `## Action Required\n\n`;
            issueBody += `1. Review the differences below\n`;
            issueBody += `2. Regenerate CBOR code: \`task zcbor-generate\`\n`;
            issueBody += `3. Update \`src/fusain.c\` if field names or types changed\n`;
            issueBody += `4. Run tests: \`task ci\`\n`;
            issueBody += `5. Commit the updated generated code\n\n`;

            issueBody += `<details>\n<summary>Detailed Differences</summary>\n\n`;
            issueBody += diffSummary;
            issueBody += `\n</details>\n\n`;

            issueBody += `---\n`;
            issueBody += `*This issue was automatically created by the [CDDL validation workflow](${context.payload.repository.html_url}/blob/master/.github/workflows/validate-cddl.yml).*\n`;

            // Check for existing open issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'cddl-validation',
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              const issue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## New discrepancy detected\n\n${issueBody}`,
              });
              console.log(`Updated existing issue #${issue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `C Fusain diverged from reference CDDL schema`,
                body: issueBody,
                labels: ['cddl-validation', 'protocol'],
              });
              console.log(`Created new issue #${issue.data.number}`);
            }

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.diff.outputs.has_diff }}" == "true" ]; then
            echo "❌ Discrepancies found - issue created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat /tmp/diff-summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ C Fusain implementation is in sync with reference CDDL" >> $GITHUB_STEP_SUMMARY
          fi
